<main>
  <button class="theme-toggle btn-accent" (click)="toggleTheme()">Toggle theme</button>
  <button class="theme-toggle cart-icon" (click)="openCart()" aria-label="Apri carrello">
    <!-- shopping bag minimal icon -->
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M3 6h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M16 10a4 4 0 0 1-8 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span class="cart-count">{{ cartCount }}</span>
  </button>

  <h1>ARTICOLI</h1>

  <!-- success popup centered -->
  <div *ngIf="lastSuccess" class="success-popup" role="status" aria-live="polite">
    <div class="success-content">{{ lastSuccess }}</div>
  </div>

  <section class="controls">
    <input type="text" placeholder="Cerca articolo..." [(ngModel)]="search" (keyup.enter)="onSearch()" />

    <select [(ngModel)]="nameFilter" (change)="onFilterChange()">
      <option value="">Lista articoli</option>
      <option *ngFor="let n of names" [value]="n">{{ n }}</option>
    </select>

    <select [(ngModel)]="sortBy" (change)="onSortChange()">
      <option value="" disabled>Ordina per...</option>
      <option value="newest">Ultimi inseriti</option>
      <option value="price-asc">Prezzo: crescente</option>
      <option value="price-desc">Prezzo: decrescente</option>
      <option value="name-asc">Nome: A-Z</option>
      <option value="name-desc">Nome: Z-A</option>
    </select>

    <button (click)="onSearch()">Cerca</button>
    <button (click)="resetFilters()">Reset filtri</button>
  </section>

  <section *ngIf="lastError; else productList">
    <p>{{ lastError }}</p>
  </section>

  <ng-template #productList>
    <div class="cards">
      <div class="card" *ngFor="let p of products" (click)="openDetail(p)">
        <div class="thumb" *ngIf="getCardSrc(p) && !isImageFailed(p); else placeholder">
          <img (error)="onImageError(p)" [src]="getCardSrc(p)" alt="{{p.name}}" />
        </div>
        <ng-template #placeholder>
          <div class="thumb placeholder">
            <!-- classic camera with slash 'image not found' icon -->
            <svg viewBox="0 0 24 24" width="96" height="96" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 6h-3.2l-1.6-2.4A1 1 0 0 0 15.6 3H8.4a1 1 0 0 0-.6.2L6.2 5H3a1 1 0 0 0-1 1v11.8c0 .6.4 1 .9 1H20a1 1 0 0 0 1-.9V7a1 1 0 0 0-1-1z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </ng-template>
        
        <div class="card-body">
          <h3 class="card-title">{{ p.name }}</h3>
          <p class="desc truncated">{{ p.description }}</p>
          
          <div class="card-footer">
            <p class="price">{{ p.price | currency:'EUR':'symbol':'1.2-2' }}</p>
            
            <button 
              class="icon-btn cart-btn" 
              [class.loading]="getButtonState(p).loading"
              (click)="addToCart(p, $event)"
              aria-label="Aggiungi al carrello" 
              title="Aggiungi al carrello">
              
              <svg *ngIf="!getButtonState(p).loading" viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 6h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 10a4 4 0 0 1-8 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="pagination" *ngIf="pageCount > 1">
      <button (click)="goToPage(page-1)" [disabled]="page===1">Prev</button>
      <span>Pagina {{page}} di {{pageCount}}</span>
      <button (click)="goToPage(page+1)" [disabled]="page===pageCount">Next</button>
    </div>

    <p *ngIf="products.length === 0">Nessun prodotto disponibile.</p>
  </ng-template>

  <div class="modal" *ngIf="selectedProduct">
    <div class="modal-content">
      <div class="detail-image-wrapper">
        <button class="modal-close" (click)="closeDetail()" aria-label="Chiudi">✕</button>
        
        <div *ngIf="getDetailSrc(selectedProduct) && !isImageFailed(selectedProduct)" class="detail-image">
          <img (error)="onImageError(selectedProduct)" [src]="getDetailSrc(selectedProduct)" alt="{{selectedProduct?.name}}" />
        </div>
        <div *ngIf="!getDetailSrc(selectedProduct) || isImageFailed(selectedProduct)" class="detail-image placeholder">
          <svg viewBox="0 0 24 24" width="120" height="120" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 6h-3.2l-1.6-2.4A1 1 0 0 0 15.6 3H8.4a1 1 0 0 0-.6.2L6.2 5H3a1 1 0 0 0-1 1v11.8c0 .6.4 1 .9 1H20a1 1 0 0 0 1-.9V7a1 1 0 0 0-1-1z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <h2 class="detail-title">{{selectedProduct?.name}}</h2>
      <p class="detail-description">{{selectedProduct?.description}}</p>
      <p class="detail-price">{{ selectedProduct?.price | currency:'EUR':'symbol':'1.2-2' }}</p>
    </div>
  </div>

  <div class="cart-modal" *ngIf="cartOpen">
    <div class="cart-panel">
      <h3>Carrello ({{ cartCount }})</h3>
      <div *ngFor="let item of cart" class="cart-item">
        <div class="ci-name">{{ item.name }}</div>
        <div class="ci-qty">
          <button (click)="changeCartQty(item, item.quantity - 1)">−</button>
          <input type="number" [value]="item.quantity" (change)="changeCartQty(item, $any($event.target).value)" />
          <button (click)="changeCartQty(item, item.quantity + 1)">+</button>
        </div>
        <div class="ci-price">{{ item.price | currency:'EUR':'symbol':'1.2-2' }}</div>
        <button class="remove-btn" (click)="removeFromCart(item)">Rimuovi</button>
      </div>

      <div class="cart-summary">
        <div>Totale:</div>
        <div>{{ cartTotal | currency:'EUR':'symbol':'1.2-2' }}</div>
      </div>

      <div class="cart-actions">
        <button (click)="closeCart()">Chiudi</button>
        <button class="btn-accent">Checkout</button>
      </div>
    </div>
  </div>
</main>
